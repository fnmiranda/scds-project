<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de DetecÃ§Ã£o Sonora - HistÃ³rico</title>
  <script src="/socket.io/socket.io.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <h1>ğŸ“Š Sistema de DetecÃ§Ã£o Sonora</h1>
        <div class="subtitle">HistÃ³rico de Eventos - Sensor KY-037</div>
      </div>

      <div class="kpi-grid">
        <div class="kpi-card">
          <span class="kpi-label">Total de Eventos</span>
          <span class="kpi-value" id="totalEvents">0</span>
        </div>
        <div class="kpi-card">
          <span class="kpi-label">MÃ©dia por Minuto</span>
          <span class="kpi-value" id="avgPerMinute">0.0</span>
        </div>
        <div class="kpi-card">
          <span class="kpi-label">Pico MÃ¡ximo</span>
          <span class="kpi-value" id="peakEvents">0</span>
        </div>
        <div class="kpi-card">
          <span class="kpi-label">CadÃªncia / min</span>
          <span class="kpi-value" id="cadenceEvents">0</span>
        </div>
        <div class="kpi-card">
          <span class="kpi-label">DuraÃ§Ã£o Total</span>
          <span class="kpi-value" id="totalDuration">0<span class="kpi-unit">min</span></span>

        
        </div>
      </div>

      <div class="controls">
        <button class="btn" id="btnSample">ğŸ“ Carregar Dados de Exemplo</button>
        <button class="btn btn-secondary" id="btnExport">ğŸ“¤ Exportar Dados</button>
        <button class="btn btn-secondary" id="btnClear">ğŸ—‘ï¸ Limpar GrÃ¡fico</button>
      </div>

      <div class="chart-container">
        <canvas id="eventsChart"></canvas>
      </div>

      <div>
        <h3 style="margin-bottom:1rem;color:#2d3748;">ğŸ“‹ Dados Detalhados</h3>
        <div style="max-height:300px;overflow-y:auto;">
          <table class="data-table" id="dataTable">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Eventos</th>
                <th>DuraÃ§Ã£o (min)</th>
                <th>Intensidade</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>

      <div class="description">
        <h3>ğŸ” Sobre o Sistema</h3>
        <p>
          Este sistema monitora eventos sonoros utilizando um sensor KY-037 conectado ao Arduino.
          O sensor detecta sons de alta intensidade e registra cada ocorrÃªncia com timestamp e intensidade,
          permitindo anÃ¡lise histÃ³rica dos dados.
        </p>
        <div class="tech-specs">
          <div class="spec-item"><div class="spec-label">Sensor</div><div class="spec-value">KY-037</div></div>
          <div class="spec-item"><div class="spec-label">Plataforma</div><div class="spec-value">Arduino Uno</div></div>
          <div class="spec-item"><div class="spec-label">AplicaÃ§Ã£o</div><div class="spec-value">DetecÃ§Ã£o de Disparos</div></div>
          <div class="spec-item"><div class="spec-label">SaÃ­da</div><div class="spec-value">Array de Eventos Temporais</div></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  // ==== DADOS DE EXEMPLO (mantive os seus) ====
  const sampleData = [
    { timestamp:'2024-01-15 08:00:00', events:12, duration:5, intensity:85 },
    { timestamp:'2024-01-15 08:05:00', events: 8, duration:5, intensity:78 },
    { timestamp:'2024-01-15 08:10:00', events:15, duration:5, intensity:92 },
    { timestamp:'2024-01-15 08:15:00', events: 6, duration:5, intensity:72 },
    { timestamp:'2024-01-15 08:20:00', events:20, duration:5, intensity:95 },
    { timestamp:'2024-01-15 08:25:00', events:10, duration:5, intensity:80 },
    { timestamp:'2024-01-15 08:30:00', events:18, duration:5, intensity:88 },
    { timestamp:'2024-01-15 08:35:00', events: 7, duration:5, intensity:75 },
    { timestamp:'2024-01-15 08:40:00', events:14, duration:5, intensity:82 },
    { timestamp:'2024-01-15 08:45:00', events: 9, duration:5, intensity:79 }
  ];

  let chart, currentData = [];

  function initializeChart() {
    const ctx = document.getElementById('eventsChart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [
        { label:'Eventos por PerÃ­odo', data:[], borderColor:'#4299e1', backgroundColor:'rgba(66,153,225,0.1)', borderWidth:3, fill:true, tension:0.4 },
        { label:'Intensidade MÃ©dia', data:[], borderColor:'#ed8936', backgroundColor:'rgba(237,137,54,0.1)', borderWidth:2, borderDash:[5,5], fill:false, yAxisID:'y1' }
      ]},
      options: {
        responsive:true, maintainAspectRatio:false, interaction:{ mode:'index', intersect:false },
        scales:{ y:{ beginAtZero:true, title:{display:true,text:'Quantidade de Eventos'}, grid:{color:'rgba(0,0,0,0.1)'} },
                 y1:{ position:'right', beginAtZero:false, suggestedMin: 70 , max:100, title:{display:true,text:'Intensidade (%)'}, grid:{drawOnChartArea:false}},
                 x:{ grid:{color:'rgba(0,0,0,0.1)'}}},
        plugins:{ legend:{position:'top'}, title:{display:true, text:'HistÃ³rico de Eventos Sonoros'} }
      }
    });
  }

  function updateDisplay() { updateChart(); updateKPIs(); updateTable(); }

  const INTENSITY_THRESH = 92;

  function updateChart() {
    if (!chart) return;
    const labels = currentData.map(item => {
      const d = new Date(item.timestamp);
      return isNaN(d.getTime()) ? item.timestamp :
        d.toLocaleTimeString('pt-BR', {minute:'2-digit', second:"2-digit"});
    });
    const validEvents = currentData.map(i => (i.intensity >= INTENSITY_THRESH) ? (i.events || 0) : 0);
    const events = currentData.map(i => i.events);
    const intensities = currentData.map(i => i.intensity);
    chart.data.labels = labels;
    chart.data.datasets[0].data = events;
    chart.data.datasets[1].data = intensities;
    chart.update();
  }

  function updateKPIs() {
    const totalEvents = currentData.reduce((s,i)=>s+(+i.events||0),0);
    const totalDuration = currentData.reduce((s,i)=>s+(+i.duration||0),0);
    const eventsArr = currentData.map(i => +i.events||0);
    const peakEvents = eventsArr.length ? Math.max(...eventsArr) : 0;
    
    const quant = currentData.reduce((total, item) => {
      return total + (item.events && (item.intensity > 91) ? 1 : 0);
    }, 0)/6;
    const cadence = qaunt/ 60*(totalDuration > 0 ? totalDuration : 1);

    console.log("duraÃ§Ã£o: "+totalDuration);
    console.log("quantidade de tiros: " + quant)

    const avgPerMinute = totalDuration>0 ? (totalEvents/totalDuration).toFixed(1) : '0.0';
    document.getElementById('totalEvents').textContent = totalEvents;
    document.getElementById('avgPerMinute').textContent = avgPerMinute;
    document.getElementById('peakEvents').textContent = peakEvents;
    document.getElementById('totalDuration').textContent = totalDuration.toFixed(2);
    document.getElementById('cadenceEvents').textContent = cadence.toFixed(2);
  }

  function updateTable() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    currentData.forEach(item => {
      const row = document.createElement('tr');
      const bar = `<div style="width:60px;height:6px;background:#e2e8f0;border-radius:3px;">
                     <div style="width:${(+item.intensity||0)}%;height:100%;background:#4299e1;border-radius:3px;"></div>
                   </div>`;
      row.innerHTML = `
        <td>${item.timestamp}</td>
        <td>${item.events}</td>
        <td>${item.duration}</td>
        <td><div style="display:flex;align-items:center;gap:8px;">${bar} ${item.intensity}%</div></td>`;
      tbody.appendChild(row);
    });
  }

  function exportData() {
    if (!currentData.length) return alert('NÃ£o hÃ¡ dados para exportar!');
    const csv = "data:text/csv;charset=utf-8," +
      "Timestamp,Eventos,DuraÃ§Ã£o(min),Intensidade(%)\n" +
      currentData.map(i => `${i.timestamp},${i.events},${i.duration},${i.intensity}`).join("\n");
    const link = Object.assign(document.createElement("a"), { href: encodeURI(csv), download: "dados_sensor_ky037.csv" });
    document.body.appendChild(link); link.click(); document.body.removeChild(link);
  }

  function clearChart(){ currentData = []; updateDisplay(); }

  function loadSampleData(){ currentData=[...sampleData]; updateDisplay(); }

  // Expostos para o cliente (Socket)
  window.appendArduinoItem = function(item){
    currentData.push(item);
    updateDisplay();
  };
  window.replaceAllData = function(arr){
    currentData = Array.isArray(arr)? arr : [];
    updateDisplay();
  };

  document.addEventListener('DOMContentLoaded', () => {
    initializeChart();
    loadSampleData(); // opcional: comente se nÃ£o quiser carregar exemplo automÃ¡tico
    document.getElementById('btnSample').onclick = loadSampleData;
    document.getElementById('btnExport').onclick = exportData;
    document.getElementById('btnClear').onclick = clearChart;
  });
  </script>

  <!-- cliente Socket.IO (separado) -->
  <script src="/public/client.js" defer></script>
</body>
</html>
